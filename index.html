<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Browser</title>
  <style>
body {
  margin: 20px;

}

.racer {
 height: 50px;
 width: 50px;
 border-radius: 5px;
 margin-top: 10px;
 background-image: url('https://cdn-icons-png.flaticon.com/512/1168/1168041.png');
 background-size: 100%;
 background-repeat: no-repeat;
}
.racer-label {
  position: absolute;
  margin-top: 40px;
  text-align: center;
}

  </style>
</head>

<body>
  <div id="starter-form">
    <div id="racer-inputs-container"></div>
    <button id="add-more-option">+ Add More</button>
    <button id="race-start-option"><b>Race!</b></button>
  </div>
  <div id="racer-container">
  </div>
  <script>
  const API_URL = 'https://api.api-ninjas.com/v1/motorcycles';
  const API_KEY = 'QvIUv0aywoBXbuXNHAreHQ==t2wcm1EX72ciNWjV';
  let inputsContainer = document.getElementById('racer-inputs-container');
  let racerContainer = document.getElementById('racer-container');
  let raceGoOpt = document.getElementById('race-start-option');
  let addMoreOpt = document.getElementById('add-more-option');

  raceGoOpt.addEventListener('click', getBikes);
  addMoreOpt.addEventListener('click', addInput);

async function getBikes() {
    for (item of inputsContainer.children) {
      let make = item.children[0].value;
      let model = item.children[1].value;
      let result = await fetch(`${API_URL}?make=${make}&model=${model}`, {headers: {'X-Api-Key': API_KEY}});
      let json = await result.json();
      if (json.length > 0) {
        let data = getRacerData(json[0]);
        if (data) {
          addRacer(data);
        } else {
          reportFailedBike(make, model);
        }
      } else {
        reportFailedBike(make, model);
      }
    }
  }

  function getBikesTest() {
    let testData = [["Indian FTR", "120", "120", "233"], ["Triumph Triple", "120", "79", "188"]]
    for (item of testData) {
      addRacer(item);
    }
  }

  function reportFailedBike(make, model) {
      alert(`Failed to find ${make} ${model}`);
  }

  function findNumberByMetric(value, metric) {
    if (!value) {
      return null;
    }
    return value.substr(0, value.toLowerCase().search(metric.toLowerCase())).trim();
  }
  function getRacerData(data) {
    console.log(data);
    let name = `${data.make} ${data.model}`;
    let power = findNumberByMetric(data.power, 'hp');
    let torque = findNumberByMetric(data.torque, 'nm');
    var weight;
    if (data.total_weight) {
      weight = findNumberByMetric(data.total_weight, 'kg');
    } else if (data.wet_weight) {
      weight = findNumberByMetric(data.wet_weight, 'kg');
    } else if (data.dry_weight) {
      weight = findNumberByMetric(data.dry_weight, 'kg');
    }

    if (power && torque && weight) {
      return [name, power, torque, weight];
    } else {
      return null;
    }
  }

  function addRacer(data) {
    // TODO: Unpack
    let name = data[0];
    let power = data[1];
    let torque = data[2];
    let weight = data[3];

    let racer = document.createElement('div');
    racer.className = 'racer';
    racer.setAttribute('power', power);
    racer.setAttribute('torque', torque);
    racer.setAttribute('weight', weight);
    racer.id = name;

    let label = document.createElement('div');
    label.className = 'racer-label';
    label.innerHTML = name;
    racer.appendChild(label);
    racerContainer.appendChild(racer);
  }

  function addInput() {
    let container = document.createElement('div');

    let makeIn = document.createElement('input');
    makeIn.placeholder = "Make...";
    container.appendChild(makeIn);

    let modelIn = document.createElement('input');
    modelIn.placeholder = "Model...";
    container.appendChild(modelIn);
    inputsContainer.appendChild(container);
  }

  function go() {
    let racers = document.getElementsByClassName('racer');
    var as = {};
    var ints = {};
    for (racer of racers) {
      var power = parseInt(racer.getAttribute('power'));
      let weight = racer.getAttribute('weight');
      var torque = parseInt(racer.getAttribute('torque'));

      let ptw = parseInt(power) / parseInt(weight);
      let a = parseInt(torque) / parseInt(weight);
      as[racer.id] = torque / 15;
      ints[racer.id] = setInterval(function(racer, a, ptw){
        return () => {
          m = ((a) * as[racer.id]) + 1 + (ptw * 7);
          racer.style.marginLeft = parseInt(window.getComputedStyle(racer).marginLeft) + m + 'px';
          as[racer.id] += 0.01;
          console.log(parseInt(racer.style.marginLeft));
          if (parseInt(racer.style.marginLeft) > 1000) {
            clearInterval(ints[racer.id]);
          }
        }
      }(racer, a, ptw), 40);
    }
  }

  addInput();
  addInput();




  </script>
</body>

</html>
